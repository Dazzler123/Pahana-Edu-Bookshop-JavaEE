<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Manage Customers - Pahana Edu Bookshop</title>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <style>
        body {
            font-family: "Segoe UI", sans-serif;
            background-color: #f8f9fa;
        }

        .sidebar {
            height: 100vh;
            background-color: #343a40;
            color: white;
            padding-top: 1rem;
        }

        .sidebar a {
            color: white;
            text-decoration: none;
            padding: 0.75rem 1rem;
            display: block;
        }

        .sidebar a:hover {
            background-color: #495057;
        }

        .card {
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body>

<!-- ğŸ”¹ Top Navbar -->
<nav class="navbar navbar-dark bg-dark">
    <div class="container-fluid">
        <span class="navbar-brand mb-2 mt-2 h1">ğŸ“š Pahana Edu Bookshop - Admin Dashboard</span>
    </div>
</nav>

<!-- ğŸ”¹ Layout -->
<div class="container-fluid">
    <div class="row">
        <!-- ğŸ”¸ Sidebar -->
        <nav class="col-md-2 d-none d-md-block bg-dark sidebar">
            <div class="position-sticky">
                <ul class="nav flex-column">
                    <li><a href="index.html">ğŸ  Dashboard</a></li>
                    <li><a href="customer.html" class="fw-bold">ğŸ‘¤ Manage Customers</a></li>
                    <li><a href="item.html">ğŸ“¦ Manage Items</a></li>
                    <li><a href="billing.html">ğŸ’³ Billing</a></li>
                    <li><a href="reports.html">ğŸ“Š Reports</a></li>
                    <li><a href="help.html">â“ Help</a></li>
                    <li><a href="logout.html">ğŸšª Logout</a></li>
                </ul>
            </div>
        </nav>

        <!-- ğŸ”¸ Main Content Area -->
        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 py-4">
            <h2 class="mb-4">ğŸ‘¤ Customer Management</h2>

            <!-- Add New Customer -->
            <div class="card mb-4">
                <div id="formHeader" class="card-header bg-primary text-white">Add New Customer</div>
                <div class="card-body">
                    <form id="addCustomerForm">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label for="account_number" class="form-label">Account Number</label>
                                <input type="text" name="account_number" id="account_number" class="form-control"
                                       required>
                            </div>
                            <div class="col-md-3">
                                <label for="name" class="form-label">Name</label>
                                <input type="text" name="name" id="name" class="form-control" required>
                            </div>
                            <div class="col-md-3">
                                <label for="address" class="form-label">Address</label>
                                <input type="text" name="address" id="address" class="form-control" required>
                            </div>
                            <div class="col-md-3">
                                <label for="telephone" class="form-label">Telephone</label>
                                <input type="number" step="0.01" name="telephone" id="telephone" class="form-control"
                                       required>
                            </div>
                            <input type="hidden" id="status" name="status"/>
                        </div>
                        <div class="mt-3 text-end">
                            <button type="submit" id="submitBtn" class="btn btn-success me-2">Add Customer</button>
                            <button type="reset" id="resetBtn" class="btn btn-outline-secondary">Reset</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Customer Table -->
            <div class="card">
                <div class="card-header bg-secondary text-white">Customer List</div>
                <div class="card-body">

                    <!-- filters -->
                    <div class="row g-3 mb-3">
                        <div class="col-md-3">
                            <input type="text" id="searchAccountNumber" class="form-control"
                                   placeholder="Search by Account Number">
                        </div>
                        <div class="col-md-3">
                            <input type="text" id="searchName" class="form-control" placeholder="Search by Name">
                        </div>
                        <div class="col-md-3">
                            <input type="text" id="searchAddress" class="form-control" placeholder="Search by Address">
                        </div>
                        <div class="col-md-3">
                            <input type="text" id="searchTelephone" class="form-control"
                                   placeholder="Search by Telephone">
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button id="resetFiltersBtn" class="btn btn-outline-secondary w-100">Reset Filters</button>
                        </div>
                    </div>

                    <!-- ğŸ§¾ Customer Table -->
                    <table class="table table-bordered table-hover table-striped">
                        <thead class="table-dark">
                        <tr>
                            <th>Account Number</th>
                            <th>Name</th>
                            <th>Address</th>
                            <th>Telephone</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                        </thead>
                        <tbody id="customerTableBody">
                        <tr>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- Footer -->
<footer class="bg-light text-center py-3 mt-1">
    &copy; 2025 Pahana Edu Bookshop. All Rights Reserved.
</footer>

<script>
    const baseURL = "http://localhost:8080/Pahana_Edu_Bookshop_JavaEE_war_exploded/";

    let isUpdateMode = false;
    let originalStatus = null;

    document.addEventListener("DOMContentLoaded", () => {
        loadAllCustomers(); // this will call attachSearchFilters at the end
    });


    // create customer
    document.getElementById("addCustomerForm").addEventListener("submit", function (e) {
        e.preventDefault();

        const form = e.target;
        const formData = new FormData(form);

        if (isUpdateMode) {
            formData.set("status", originalStatus); // maintain original status
        }

        const formParams = new URLSearchParams(formData).toString();

        fetch(baseURL + "customer", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded"
            },
            body: formParams
        })
            .then(response => {
                if (!response.ok) return response.json().then(err => {
                    throw err
                });
                return response.json();
            })
            .then(data => {
                alert(data.message);
                form.reset();
                loadAllCustomers();

                // Reset UI
                isUpdateMode = false;
                originalStatus = null;
                const submitBtn = document.getElementById("submitBtn");
                submitBtn.textContent = "Add Customer";
                submitBtn.classList.remove("btn-warning");
                submitBtn.classList.add("btn-success");
                document.getElementById("account_number").readOnly = false;
            })
            .catch(error => {
                alert("Error: " + error.message);
            });
    });

    // reset customer form
    document.getElementById("resetBtn").addEventListener("click", function () {
        isUpdateMode = false;
        originalStatus = null;

        document.getElementById("formHeader").textContent = "Add New Customer";
        const submitBtn = document.getElementById("submitBtn");
        submitBtn.textContent = "Add Customer";
        submitBtn.classList.remove("btn-warning");
        submitBtn.classList.add("btn-success");

        document.getElementById("account_number").readOnly = false;
    });


    /**
     * This method is used to load all available customers to the grid.
     *
     */
    function loadAllCustomers() {
        fetch(baseURL + "customer")
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw err });
                }
                return response.json();
            })
            .then(data => {
                const tbody = document.getElementById("customerTableBody");
                tbody.innerHTML = ""; // clear existing

                data.customers.forEach(c => {
                    const row = document.createElement("tr");

                    let statusLabel = '';
                    let statusClass = '';

                    switch (c.status) {
                        case 'A': statusLabel = 'Active'; statusClass = 'bg-success'; break;
                        case 'I': statusLabel = 'Inactive'; statusClass = 'bg-secondary'; break;
                        case 'D': statusLabel = 'Deleted'; statusClass = 'bg-danger'; break;
                        default:  statusLabel = 'Unknown'; statusClass = 'bg-dark';
                    }

                    row.innerHTML = `
                    <td>${c.accountNumber}</td>
                    <td>${c.name}</td>
                    <td>${c.address}</td>
                    <td>${c.telephone}</td>
                    <td><span class="badge ${statusClass}">${statusLabel}</span></td>
                    <td>
                        <button class="btn btn-sm btn-success activate-btn" data-id="${c.accountNumber}" ${c.status === 'A' || c.status === 'D' ? 'disabled' : ''}>Activate</button>
                        <button class="btn btn-sm btn-warning inactivate-btn" data-id="${c.accountNumber}" ${c.status === 'I' || c.status === 'D' ? 'disabled' : ''}>Inactivate</button>
                        <button class="btn btn-sm btn-primary edit-btn"
                            data-account="${c.accountNumber}"
                            data-name="${c.name}"
                            data-address="${c.address}"
                            data-telephone="${c.telephone}"
                            data-status="${c.status}"
                            ${c.status === 'D' || c.status === 'I' ? 'disabled' : ''}>
                            Edit
                        </button>
                        <button class="btn btn-sm btn-danger delete-btn" data-id="${c.accountNumber}" ${c.status === 'D' ? 'disabled' : ''}>Delete</button>
                    </td>
                `;

                    tbody.appendChild(row);

                    const editBtn = row.querySelector('.edit-btn');
                    if (editBtn) {
                        editBtn.addEventListener('click', () => {
                            document.getElementById("formHeader").textContent = "Update Customer";
                            document.getElementById("account_number").value = editBtn.dataset.account;
                            document.getElementById("name").value = editBtn.dataset.name;
                            document.getElementById("address").value = editBtn.dataset.address;
                            document.getElementById("telephone").value = editBtn.dataset.telephone;
                            document.getElementById("status").value = editBtn.dataset.status;

                            isUpdateMode = true;
                            originalStatus = editBtn.dataset.status;

                            const submitBtn = document.getElementById("submitBtn");
                            submitBtn.textContent = "Update Customer";
                            submitBtn.classList.remove("btn-success");
                            submitBtn.classList.add("btn-warning");

                            document.getElementById("account_number").readOnly = true;
                        });
                    }

                });

                attachStatusEventHandlers();
                attachSearchFilters();

                document.getElementById("resetFiltersBtn").addEventListener("click", () => {
                    document.getElementById("searchAccountNumber").value = "";
                    document.getElementById("searchName").value = "";
                    document.getElementById("searchAddress").value = "";
                    document.getElementById("searchTelephone").value = "";
                    filterCustomers();
                    document.getElementById("searchAccountNumber").focus();
                });

                filterCustomers(); // re-apply filters based on current input values
            })
            .catch(error => {
                alert("Failed to load customers: " + error.message);
            });
    }


    /**
     * This method is used to trigger the customer manage events based on
     * user's action on a customer's record
     *
     */
    function attachStatusEventHandlers() {
        document.querySelectorAll('.activate-btn').forEach(btn => {
            btn.addEventListener('click', () => updateCustomerStatus(btn.dataset.id, 'A'));
        });

        document.querySelectorAll('.inactivate-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                if (confirm("Are you sure you want to update this customer?")) {
                    updateCustomerStatus(btn.dataset.id, 'I')
                }
            });
        });

        document.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                if (confirm("Are you sure you want to delete this customer?")) {
                    updateCustomerStatus(btn.dataset.id, 'D');
                }
            });
        });
    }

    function attachSearchFilters() {
        document.getElementById("searchAccountNumber").addEventListener("input", filterCustomers);
        document.getElementById("searchName").addEventListener("input", filterCustomers);
        document.getElementById("searchAddress").addEventListener("input", filterCustomers);
        document.getElementById("searchTelephone").addEventListener("input", filterCustomers);
    }

    /**
     * This method is used to filter customers (grid search filters)
     */
    function filterCustomers() {
        const accFilter = document.getElementById("searchAccountNumber").value.toLowerCase();
        const nameFilter = document.getElementById("searchName").value.toLowerCase();
        const addressFilter = document.getElementById("searchAddress").value.toLowerCase();
        const telFilter = document.getElementById("searchTelephone").value.toLowerCase();

        const rows = document.querySelectorAll("#customerTableBody tr");

        rows.forEach(row => {
            const acc = row.children[0]?.textContent.toLowerCase();
            const name = row.children[1]?.textContent.toLowerCase();
            const address = row.children[2]?.textContent.toLowerCase();
            const tel = row.children[3]?.textContent.toLowerCase();

            const match =
                acc.includes(accFilter) &&
                name.includes(nameFilter) &&
                address.includes(addressFilter) &&
                tel.includes(telFilter);

            row.style.display = match ? "" : "none";
        });
    }


    /**
     * This method is used to update customer's status
     * @param accountNumber
     * @param newStatus
     */
    function updateCustomerStatus(accountNumber, newStatus) {
        fetch(baseURL + "customer", {
            method: "PUT",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ account_number: accountNumber, status: newStatus })
        })
            .then(response => {
                if (!response.ok) return response.json().then(err => { throw err });
                return response.json();
            })
            .then(data => {
                alert(data.message);
                loadAllCustomers();
            })
            .catch(error => {
                alert("Error: " + error.message);
            });
    }


</script>


</body>
</html>