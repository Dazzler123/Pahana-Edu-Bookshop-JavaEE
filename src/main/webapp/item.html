<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Manage Items - Pahana Edu Bookshop</title>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <style>
        body {
            font-family: "Segoe UI", sans-serif;
            background-color: #f8f9fa;
        }

        .sidebar {
            height: 100vh;
            background-color: #343a40;
            color: white;
            padding-top: 1rem;
        }

        .sidebar a {
            color: white;
            text-decoration: none;
            padding: 0.75rem 1rem;
            display: block;
        }

        .sidebar a:hover {
            background-color: #495057;
        }

        .card {
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body>

<!-- Top Navbar -->
<nav class="navbar navbar-dark bg-dark">
    <div class="container-fluid">
        <span class="navbar-brand mb-2 mt-2 h1">üìö Pahana Edu Bookshop - Admin Dashboard</span>
    </div>
</nav>

<!-- Layout -->
<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <nav class="col-md-2 d-none d-md-block bg-dark sidebar">
            <div class="position-sticky">
                <ul class="nav flex-column">
                    <li><a href="index.html">üè† Dashboard</a></li>
                    <li><a href="customer.html" class="fw-bold">üë§ Manage Customers</a></li>
                    <li><a href="item.html">üì¶ Manage Items</a></li>
                    <li><a href="billing.html">üí≥ Billing</a></li>
                    <li><a href="reports.html">üìä Reports</a></li>
                    <li><a href="help.html">‚ùì Help</a></li>
                    <li><a href="logout.html">üö™ Logout</a></li>
                </ul>
            </div>
        </nav>

        <!-- Main Content Area -->
        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 py-4">
            <h2 class="mb-4">üì¶ Item Management</h2>

            <!-- Add New Item -->
            <div class="card mb-4">
                <div id="formHeader" class="card-header bg-primary text-white">Add New Item</div>
                <div class="card-body">
                    <form id="addItemForm">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label for="item_code" class="form-label">Item Code</label>
                                <input type="text" name="item_code" id="item_code" class="form-control"
                                       required>
                            </div>
                            <div class="col-md-3">
                                <label for="name" class="form-label">Name</label>
                                <input type="text" name="name" id="name" class="form-control" required>
                            </div>
                            <div class="col-md-3">
                                <label for="unit_price" class="form-label">Unit Price</label>
                                <input type="text" name="unit_price" id="unit_price" class="form-control" required>
                            </div>
                            <div class="col-md-3">
                                <label for="qty_on_hand" class="form-label">Qty On Hand</label>
                                <input type="text" name="qty_on_hand" id="qty_on_hand" class="form-control"
                                       required>
                            </div>
                            <input type="hidden" id="status" name="status"/>
                        </div>
                        <div class="mt-3 text-end">
                            <button type="submit" id="submitBtn" class="btn btn-success me-2">Add Item</button>
                            <button type="reset" id="resetBtn" class="btn btn-outline-secondary">Reset</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Item Table -->
            <div class="card">
                <div class="card-header bg-secondary text-white">Item List</div>
                <div class="card-body">

                    <!-- filters -->
                    <div class="row g-3 mb-3">
                        <div class="col-md-3">
                            <input type="text" id="searchItemCode" class="form-control"
                                   placeholder="Search by Item Code">
                        </div>
                        <div class="col-md-3">
                            <input type="text" id="searchName" class="form-control" placeholder="Search by Name">
                        </div>
                        <div class="col-md-3">
                            <input type="text" id="searchUnitPrice" class="form-control" placeholder="Search by Unit Price">
                        </div>
                        <div class="col-md-3">
                            <input type="text" id="searchQtyOnHand" class="form-control"
                                   placeholder="Search by Qty On Hand">
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button id="resetFiltersBtn" class="btn btn-outline-secondary w-100">Reset Filters</button>
                        </div>
                    </div>

                    <!-- Item Table -->
                    <table class="table table-bordered table-hover table-striped">
                        <thead class="table-dark">
                        <tr>
                            <th>Item Code</th>
                            <th>Name</th>
                            <th>Unit Price</th>
                            <th>Qty On Hand</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                        </thead>
                        <tbody id="itemTableBody">
                        <tr>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- Footer -->
<footer class="bg-light text-center py-3 mt-1">
    &copy; 2025 Pahana Edu Bookshop. All Rights Reserved.
</footer>

<script>
    const baseURL = "http://localhost:8080/Pahana_Edu_Bookshop_JavaEE_war_exploded/";

    let isUpdateMode = false;
    let originalStatus = null;

    document.addEventListener("DOMContentLoaded", () => {
        loadAllItems(); // this will call attachSearchFilters at the end
    });


    // create customer
    document.getElementById("addItemForm").addEventListener("submit", function (e) {
        e.preventDefault();

        const form = e.target;
        const formData = new FormData(form);

        if (isUpdateMode) {
            formData.set("status", originalStatus); // maintain original status
        }

        const formParams = new URLSearchParams(formData).toString();

        fetch(baseURL + "item", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded"
            },
            body: formParams
        })
            .then(response => {
                if (!response.ok) return response.json().then(err => {
                    throw err
                });
                return response.json();
            })
            .then(data => {
                alert(data.message);
                form.reset();
                loadAllItems();

                // Reset UI
                isUpdateMode = false;
                originalStatus = null;
                const submitBtn = document.getElementById("submitBtn");
                submitBtn.textContent = "Add Item";
                submitBtn.classList.remove("btn-warning");
                submitBtn.classList.add("btn-success");
                document.getElementById("item_code").readOnly = false;
            })
            .catch(error => {
                alert("Error: " + error.message);
            });
    });

    // reset item form
    document.getElementById("resetBtn").addEventListener("click", function () {
        isUpdateMode = false;
        originalStatus = null;

        document.getElementById("formHeader").textContent = "Add New Item";
        const submitBtn = document.getElementById("submitBtn");
        submitBtn.textContent = "Add Item";
        submitBtn.classList.remove("btn-warning");
        submitBtn.classList.add("btn-success");

        document.getElementById("item_code").readOnly = false;
    });


    /**
     * This method is used to load all available items to the grid.
     *
     */
    function loadAllItems() {
        fetch(baseURL + "item")
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => {
                        throw err
                    });
                }
                return response.json();
            })
            .then(data => {
                const tbody = document.getElementById("itemTableBody");
                tbody.innerHTML = ""; // clear existing

                data.items.forEach(c => {
                    const row = document.createElement("tr");

                    let statusLabel = '';
                    let statusClass = '';

                    switch (c.status) {
                        case 'A':
                            statusLabel = 'Active';
                            statusClass = 'bg-success';
                            break;
                        case 'I':
                            statusLabel = 'Inactive';
                            statusClass = 'bg-secondary';
                            break;
                        case 'D':
                            statusLabel = 'Deleted';
                            statusClass = 'bg-danger';
                            break;
                        default:
                            statusLabel = 'Unknown';
                            statusClass = 'bg-dark';
                    }

                    row.innerHTML = `
                    <td>${c.itemCode}</td>
                    <td>${c.name}</td>
                    <td>${c.unitPrice}</td>
                    <td>${c.qtyOnHand}</td>
                    <td><span class="badge ${statusClass}">${statusLabel}</span></td>
                    <td>
                        <button class="btn btn-sm btn-success activate-btn" data-id="${c.itemCode}" ${c.status === 'A' || c.status === 'D' ? 'disabled' : ''}>Activate</button>
                        <button class="btn btn-sm btn-warning inactivate-btn" data-id="${c.itemCode}" ${c.status === 'I' || c.status === 'D' ? 'disabled' : ''}>Inactivate</button>
                        <button class="btn btn-sm btn-primary edit-btn"
                            data-itemcode="${c.itemCode}"
                            data-name="${c.name}"
                            data-unitprice="${c.unitPrice}"
                            data-qtyonhand="${c.qtyOnHand}"
                            data-status="${c.status}"
                            ${c.status === 'D' || c.status === 'I' ? 'disabled' : ''}>
                            Edit
                        </button>
                        <button class="btn btn-sm btn-danger delete-btn" data-id="${c.itemCode}" ${c.status === 'D' ? 'disabled' : ''}>Delete</button>
                    </td>
                `;

                    tbody.appendChild(row);

                    const editBtn = row.querySelector('.edit-btn');
                    if (editBtn) {
                        editBtn.addEventListener('click', () => {
                            document.getElementById("formHeader").textContent = "Update Item";
                            document.getElementById("item_code").value = editBtn.dataset.itemcode;
                            document.getElementById("name").value = editBtn.dataset.name;
                            document.getElementById("unit_price").value = editBtn.dataset.unitprice;
                            document.getElementById("qty_on_hand").value = editBtn.dataset.qtyonhand;
                            document.getElementById("status").value = editBtn.dataset.status;

                            isUpdateMode = true;
                            originalStatus = editBtn.dataset.status;

                            const submitBtn = document.getElementById("submitBtn");
                            submitBtn.textContent = "Update Item";
                            submitBtn.classList.remove("btn-success");
                            submitBtn.classList.add("btn-warning");

                            document.getElementById("item_code").readOnly = true;
                        });
                    }

                });

                attachStatusEventHandlers();
                attachSearchFilters();

                document.getElementById("resetFiltersBtn").addEventListener("click", () => {
                    document.getElementById("searchItemCode").value = "";
                    document.getElementById("searchName").value = "";
                    document.getElementById("searchUnitPrice").value = "";
                    document.getElementById("searchQtyOnHand").value = "";
                    filterItems();
                    document.getElementById("searchItemCode").focus();
                });

                filterItems(); // re-apply filters based on current input values
            })
            .catch(error => {
                alert("Failed to load items: " + error.message);
            });
    }


    /**
     * This method is used to trigger the item manage events based on
     * user's action on a items's record
     *
     */
    function attachStatusEventHandlers() {
        document.querySelectorAll('.activate-btn').forEach(btn => {
            btn.addEventListener('click', () => updateItemStatus(btn.dataset.id, 'A'));
        });

        document.querySelectorAll('.inactivate-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                if (confirm("Are you sure you want to update this item?")) {
                    updateItemStatus(btn.dataset.id, 'I')
                }
            });
        });

        document.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                if (confirm("Are you sure you want to delete this item?")) {
                    updateItemStatus(btn.dataset.id, 'D');
                }
            });
        });
    }

    function attachSearchFilters() {
        document.getElementById("searchItemCode").addEventListener("input", filterItems);
        document.getElementById("searchName").addEventListener("input", filterItems);
        document.getElementById("searchUnitPrice").addEventListener("input", filterItems);
        document.getElementById("searchQtyOnHand").addEventListener("input", filterItems);
    }

    /**
     * This method is used to filter item (grid search filters)
     */
    function filterItems() {
        const itemCodeFilter = document.getElementById("searchItemCode").value.toLowerCase();
        const nameFilter = document.getElementById("searchName").value.toLowerCase();
        const unitPriceFilter = document.getElementById("searchUnitPrice").value.toLowerCase();
        const qtyOnHandFilter = document.getElementById("searchQtyOnHand").value.toLowerCase();

        const rows = document.querySelectorAll("#itemTableBody tr");

        rows.forEach(row => {
            const itemCode = row.children[0]?.textContent.toLowerCase();
            const name = row.children[1]?.textContent.toLowerCase();
            const unitPrice = row.children[2]?.textContent.toLowerCase();
            const qtyOnHand = row.children[3]?.textContent.toLowerCase();

            const match =
                itemCode.includes(itemCodeFilter) &&
                name.includes(nameFilter) &&
                unitPrice.includes(unitPriceFilter) &&
                qtyOnHand.includes(qtyOnHandFilter);

            row.style.display = match ? "" : "none";
        });
    }


    /**
     * This method is used to update item's status
     *
     * @param itemCode
     * @param newStatus
     */
    function updateItemStatus(itemCode, newStatus) {
        fetch(baseURL + "item", {
            method: "PUT",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({item_code: itemCode, status: newStatus})
        })
            .then(response => {
                if (!response.ok) return response.json().then(err => {
                    throw err
                });
                return response.json();
            })
            .then(data => {
                alert(data.message);
                loadAllItems();
            })
            .catch(error => {
                alert("Error: " + error.message);
            });
    }


</script>


</body>
</html>